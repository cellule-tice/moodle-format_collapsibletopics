{"version":3,"file":"collapsibletopics.min.js","sources":["../src/collapsibletopics.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for the collapsible sections feature.\n *\n * @module    format_collapsibletopics\n * @author     Jean-Roch Meurisse\n * @copyright  2018 University of Namur - Cellule TICE\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/log', 'core/str'], function($, log, str) {\n\n    \"use strict\";\n\n    /**\n     * Update toggles state of current course in browser storage.\n     * @param {number} course The current course\n     * @param {array} toggles The list of open sections\n     * @param {String} storage The configured storage type (local/session)\n     */\n    var setState = function(course, toggles, storage) {\n        if (storage == 'local') {\n            window.localStorage.setItem('sections-toggle-' + course, JSON.stringify(toggles));\n        } else if (storage == 'session') {\n            window.sessionStorage.setItem('sections-toggle-' + course, JSON.stringify(toggles));\n        }\n    };\n\n    /**\n     * Update toggles state of current course in browser storage.\n     * @param {number} course The current course\n     * @param {String} storage The configured storage type (local/session)\n     * @returns the list of open sections for the current course\n     */\n    var getState = function(course, storage) {\n        var toggles;\n        if (storage == 'local') {\n            toggles = window.localStorage.getItem('sections-toggle-' + course);\n        } else if (storage == 'session') {\n            toggles = window.sessionStorage.getItem('sections-toggle-' + course);\n        }\n        if (toggles === null) {\n            return {};\n        } else {\n            return JSON.parse(toggles);\n        }\n    };\n\n    return {\n        init: function(args) {\n            log.debug('Format collapsibletopics AMD module initialized');\n            $(document).ready(function($) {\n                var sectiontoggles;\n                var keepstateoversession = args.keepstateoversession;\n                var storage;\n                if (keepstateoversession == 1) {\n                    // Use browser local storage.\n                    storage = 'local';\n                } else {\n                    // Use browser session storage.\n                    storage = 'session';\n                }\n\n                sectiontoggles = getState(args.course, storage);\n\n                setTimeout(function() {\n                    for (var section in sectiontoggles) {\n                        section = '#collapse-' + parseInt(section);\n                        $(section).collapse('show');\n                    }\n                    var currentcontent = $('.section.current a.sectiontoggle').attr('href');\n                    $(currentcontent).collapse('show');\n                }, 50);\n\n                // Handle toggle all sections.\n                $('body').on('click', '.expandall', function(event) {\n                    event.preventDefault();\n                    var target = event.target;\n                    $(target).removeClass('expandall').addClass('collapseall').html(M.util.get_string('collapseall', 'moodle'));\n\n                    $('.sectiontoggle').each(function(index) {\n                        var section = '#collapse-' + (index + 1);\n                        $(section).collapse('show');\n                        if (!sectiontoggles.hasOwnProperty(index + 1)) {\n                            sectiontoggles[index + 1] = \"true\";\n                            setState(args.course, sectiontoggles, storage);\n                        }\n                    });\n                });\n\n                $('body').on('click', '.collapseall', function(event) {\n                    event.preventDefault();\n                    var target = event.target;\n                    $(target).removeClass('collapseall').addClass('expandall').html(M.util.get_string('expandall', 'moodle'));\n                    $('.sectiontoggle').each(function(index) {\n                        var section = '#collapse-' + (index + 1);\n                        $(section).collapse('hide');\n                        if (sectiontoggles.hasOwnProperty(index + 1)) {\n                            delete sectiontoggles[index + 1];\n                            setState(args.course, sectiontoggles, storage);\n                        }\n                    });\n                });\n                $('#nav-drawer div.media').on('click', function(event) {\n\n                    var href = $(event.target).parent().parent().parent().attr('href');\n\n                    if (href.lastIndexOf('#section-') != -1) {\n                        var index = href.substring(href.lastIndexOf('-') + 1);\n                        var attr = '#collapse-' + index;\n                        $(attr).collapse('show');\n                    }\n                });\n\n                $('.collapse').on('show.bs.collapse', function(event) {\n                    var sectionstringid = $(event.target).attr('id');\n                    var sectionid = sectionstringid.substring(sectionstringid.lastIndexOf('-') + 1);\n\n                    if (!sectiontoggles.hasOwnProperty(sectionid)) {\n                        sectiontoggles[sectionid] = \"true\";\n                        setState(args.course, sectiontoggles, storage);\n                    }\n                });\n\n                $('.collapse').on('hide.bs.collapse', function(event) {\n                    var sectionstringid = $(event.target).attr('id');\n                    var sectionid = sectionstringid.substring(sectionstringid.lastIndexOf('-') + 1);\n\n                    if (sectiontoggles.hasOwnProperty(sectionid)) {\n                        delete sectiontoggles[sectionid];\n                        setState(args.course, sectiontoggles, storage);\n                    }\n                });\n                $('body').on('click', '.togglecompletion button', function(event) {\n                    var target = event.target;\n                    var state = $(target).parent().parent().children('input[name=\"completionstate\"]').val();\n                    var section = ($(target).closest('li.section'));\n                    var progressbar = $(section).find('.progress-bar');\n                    var oldvalue = parseInt($(progressbar).attr('aria-valuenow'));\n                    var newvalue = state == 1 ? oldvalue + 1 : oldvalue - 1;\n                    var total = parseInt($(progressbar).attr('aria-valuemax'));\n                    var percent = Math.round((newvalue / total * 100));\n                    $(progressbar).attr('aria-valuenow', newvalue);\n                    $(progressbar).attr('style', 'width: ' + percent + '%');\n                    var strings = [\n                        {\n                            key: 'progresstotal',\n                            component: 'completion',\n                            param: {\n                                complete: newvalue,\n                                total: total\n                            }\n                        }\n                    ];\n                    str.get_strings(strings).then(function(progress) {\n                        $(progressbar).attr('data-original-title', progress);\n                        return true;\n                    });\n\n                });\n            });\n        }\n    };\n});\n"],"names":["define","$","log","str","setState","course","toggles","storage","window","localStorage","setItem","JSON","stringify","sessionStorage","init","args","debug","document","ready","sectiontoggles","keepstateoversession","getItem","parse","getState","setTimeout","section","parseInt","collapse","currentcontent","attr","on","event","preventDefault","target","removeClass","addClass","html","M","util","get_string","each","index","hasOwnProperty","href","parent","lastIndexOf","substring","sectionstringid","sectionid","state","children","val","closest","progressbar","find","oldvalue","newvalue","total","percent","Math","round","strings","key","component","param","complete","get_strings","then","progress"],"mappings":"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"}